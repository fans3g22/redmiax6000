name: OpenWrt Builder (Minimal)

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt.git
  REPO_BRANCH: master
  TARGET: mediatek/filogic
  PROFILE: xiaomi_redmi-router-ax6000
  JOBS: 4  # 并行编译线程数

jobs:
  build:
    name: Build OpenWrt Minimal Firmware
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout 仓库
      - name: Checkout workflow repo
        uses: actions/checkout@v3

      # 2. 安装编译依赖
      - name: Setup build environment
        run: |
          sudo apt update
          sudo apt install -y build-essential git libncurses5-dev libncursesw5-dev \
          zlib1g-dev gawk flex quilt libssl-dev xsltproc wget unzip python3 python3-distutils-extra

      # 3. 克隆 OpenWrt 源码
      - name: Clone OpenWrt source
        run: |
          git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt

      # 4. 执行 diy-part1.sh 添加 feeds
      - name: Run DIY Part 1 (add feeds)
        run: |
          chmod +x diy-part1.sh
          ./diy-part1.sh

      # 5. 更新并安装 feeds
      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 6. 配置 minimal 配置 + 启用目标设备和插件
      - name: Configure minimal target and packages
        run: |
          cd openwrt
          # 生成默认配置
          make defconfig

          # 启用目标设备
          sed -i "s/^# CONFIG_TARGET_mediatek_filogic is not set/CONFIG_TARGET_mediatek_filogic=y/" .config
          sed -i "s/^# CONFIG_TARGET_DEVICE_xiaomi_redmi-router-ax6000 is not set/CONFIG_TARGET_DEVICE_xiaomi_redmi-router-ax6000=y/" .config

          # 启用必要插件
          sed -i 's/^# CONFIG_PACKAGE_luci-app-adguardhome is not set/CONFIG_PACKAGE_luci-app-adguardhome=y/' .config
          sed -i 's/^# CONFIG_PACKAGE_adguardhome is not set/CONFIG_PACKAGE_adguardhome=y/' .config
          sed -i 's/^# CONFIG_PACKAGE_nikki is not set/CONFIG_PACKAGE_nikki=y/' .config

          # 禁用不必要默认包（示例，可按需增加）
          sed -i 's/^CONFIG_PACKAGE_luci=y/CONFIG_PACKAGE_luci=n/' .config
          sed -i 's/^CONFIG_PACKAGE_luci-app-firewall=y/CONFIG_PACKAGE_luci-app-firewall=n/' .config

      # 7. 编译固件
      - name: Compile minimal firmware
        run: |
          cd openwrt
          make -j$JOBS V=s

      # 8. 上传固件
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-bin
          path: openwrt/bin/targets/mediatek/filogic/*.bin
