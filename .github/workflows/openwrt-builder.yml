name: OpenWrt Builder

on:
  workflow_dispatch:  # 手动触发
  push:
    branches:
      - main

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt.git
  REPO_BRANCH: master
  TARGET: mediatek/filogic
  PROFILE: xiaomi_redmi-router-ax6000
  JOBS: 4  # 并行编译线程数
  EXTRA_FEEDS: "https://github.com/你的源/nikki-package.git"

jobs:
  build:
    name: Build OpenWrt
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v3

      - name: Setup build environment
        run: |
          sudo apt update
          sudo apt install -y build-essential git libncurses5-dev libncursesw5-dev zlib1g-dev \
          gawk flex quilt libssl-dev xsltproc wget unzip python3 python3-distutils rsync

      - name: Clone OpenWrt source
        run: |
          git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add extra feeds (nikki)
        run: |
          cd openwrt
          echo "src-git myfeeds $EXTRA_FEEDS" >> feeds.conf.default
          ./scripts/feeds update myfeeds
          ./scripts/feeds install nikki

      - name: Configure target and packages
        run: |
          cd openwrt
          make defconfig
          # 启用目标设备
          sed -i "s/CONFIG_TARGET_|TARGET_|PROFILE_/CONFIG_TARGET_$TARGET=y/" .config || true
          sed -i "s/CONFIG_TARGET_DEVICE_|PROFILE_/CONFIG_TARGET_DEVICE_$PROFILE=y/" .config || true
          # 启用 AdGuardHome 和 nikki
          sed -i 's/CONFIG_PACKAGE_luci-app-adguardhome=n/CONFIG_PACKAGE_luci-app-adguardhome=y/' .config
          sed -i 's/CONFIG_PACKAGE_adguardhome=n/CONFIG_PACKAGE_adguardhome=y/' .config
          sed -i 's/CONFIG_PACKAGE_nikki=n/CONFIG_PACKAGE_nikki=y/' .config

      - name: Compile firmware
        run: |
          cd openwrt
          make -j$JOBS V=s

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v3
        with:
          name: firmware-bin
          path: openwrt/bin/targets/mediatek/filogic/*.bin
